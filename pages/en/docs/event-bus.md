# Event bus

The event bus implements cooperative multitasking between the actions performed within it. Each action is performed within a separate thread (Fiber) in an isolated DI container. You can control execution using state handlers, triggers, and subscriptions to events generated by actions.

### General scheme of work

<img src="https://duyler.github.io/img/event-bus.svg" width="100%" alt="">


### Types of states

**Main context states:**

* MainBegin - occurs once before the bus starts
* MainCyclic - occurs at least once and repeats until the task queue is empty in `Mode::Queue` mode, or cyclically if `Mode::Loop`
* MainBefore - occurs before the action is assembled and launched
* MainSuspend - occurs if the action calls `Fiber::suspend()`. If there are other actions in the queue, they will be started.
* MainResume - occurs before control returns to action. If no handlers are defined for the state and a callback function was passed to `Fiber::suspend()`, it will be run and the callback function's return value will be summarized into the action context.
* MainAfter - occurs after the action is completed
* MainEmpty - occurs if task queue is empty
* MainUnresolved - occurs if the task could not be allowed to execute
* MainEnd - occurs when the task queue is empty and all actions are completed (only achievable in `Mode::Queue` mode)

**States in the context of an action (within Fiber):**

* ActionBefore - occurs before the action is performed
* ActionAfter - occurs after the action is completed
* ActionThrowing - occurs if the action throws an exception

Each state can be handled using state handlers. For each state type, there is a specific set of functions available for interacting with the bus from the state handler.


### Overview of properties for actions

`string|UnitEnum $id` - Unique ID of the action. For example: `'MyService.DoWork'`.

`string|Closure $handler` - An anonymous function or invokable class for action handler.

`array $required` - An array of action IDs. A target action may require the execution of other actions that will be a condition for performing the target action. The result of performing the requested actions can be passed to the target action. If at least one of the requested actions returns a result with the status `ResultStatus::Fail`, then the target action will not be executed.

`array $listen` - The action will be launched after an events with the specified ID is transmitted to the bus. If a contract is passed to an event, it can be passed to an action.

`array $bind` - An array of interface mappings for a DI container. For example: `[MyInterface::class => MyClass::class]`. See [DI](https://github.com/duyler/di).

`array $providers` - An array of service providers for the DI container. See [DI](https://github.com/duyler/di).

`array $definitions` - Array of values for class constructors. For example: `[MyClass::class => ['argName' => 'value']]` See [DI](https:github.comduylerconfig).

`?string $argument` - Action argument type.

`string|Closure|null $argumentFactory` - An anonymous function or invokable class for build the action argument.

`?string $type` - The return type of the action.

`bool $immutable` - establishes the possibility of using mutable types of returned values.

`string|Closure|null $rollback` - An anonymous function or invokable class that is called to roll back an action if an exception is thrown anywhere in the program.

`bool $externalAccess` - Allow access to the result of an action from `BusInterface` or state handlers.

`bool $repeatable` - Permission to repeat an action.

`bool $lock` - If an action uses parallel execution within `Fiber::suspend()` (eg Parallel php extension), this ensures that the repeated actions are executed in sequence.

`bool $private` - If set to true, this action CANNOT be required in other actions.

`array $sealed` - An array of action IDs that are allowed to request this action and receive its result.

`bool $silent` - If set to true, the action WILL NOT generate an internal completion event for that action. Subscribing to such an action is not possible and will generate an exception.

`array $alternates` - An array of action identifiers, the result of which can replace the result of the target action. The result of the current target action will be replaced if it returns a result with the status ResultStatus::Fail.

`int $retries` - Number of retries if the action returns a result with ResultStatus:Fail.

`?DateInterval $retryDelay` - The delay time between repetitions

`array $labels` - Any arbitrary data. Can be useful when implementing state handlers.
